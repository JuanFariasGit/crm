{% extends "core/model-page.html" %}

{% block content %}
{% csrf_token %}
<h5 class="text-center">LISTA DE PRODUTOS</h5>
{% if messages %}
  {% for message in messages %}
  <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  {% endfor %}
  <div id="message-ajax"></div>
{% endif %}
<a class="btn btn-primary mb-3" href="{% url 'product:create' %}"><i class="fas fa-plus-circle fa-lg"></i></a>
<div class="table-responsive">  
  <table id="table" class="table table-striped table-bordered text-center">
    <thead>
      <tr>
        <th>Código do Produto</th>
        <th>Item</th>
        <th>Unidade de Medida</th>
        <th>Custo Unitario</th>
        <th>Preço Unitario</th>
        <th>"</th>
      </tr>
    </thead>
    <tfoot>
      <tr>
        <th>Código do Produto</th>
        <th>Item</th>
        <th>Unidade de Medida</th>
        <th>Custo Unitario</th>
        <th>Preço Unitario</th>
        <th>"</th>
      </tr>
    </tfoot>
  </table>
</div>
<div id="modal" class="modal fade" role="dialog" data-backdrop="static">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header"></div>
          <div class="modal-footer"></div>
      </div>
  </div>
</div>
{% endblock %}


{% block script %} 
<script>
  const cookie = document.cookie
  const csrf_token = cookie.split("=")[1]

  const table = $('#table').DataTable( {
        "columnDefs": [{
        "targets": [ 5 ],
        "orderable": false
        }],
        "order": [[ 0, "desc" ]],
        "ajax": {
          "method": "POST",
          "url": "{% url 'product:list' %}",
          "headers": {
            "X-CSRFToken": csrf_token,
          }
        },
        "columns": [
            {"data":"Código do Produto"},
            {"data":"Item"},
            {"data":"Unidade de Medida"},
            {"data":"Custo Unitario"},
            {"data":"Preço Unitario"},
            {"data":""}
        ],
        "lengthMenu": [[5, 10, 15], [5, 10, 15]],
        "language": {
            "infoFiltered":   "(filtrado do total de _MAX_ entradas)",
            "zeroRecords": "Nenhum registro correspondente encontrado",
            "loadingRecords": "Carregando...",
            "lengthMenu": "_MENU_ registros por página",
            "info": "Mostrando _START_ até _END_ de _TOTAL_ registros",
            "search": "Pesquisar",
            "paginate": {
            "next":  "›",
            "previous": "‹"
            }
        },
    });

    const deleteProductModal = (id, item) => {
      $('#modal').modal('show')
      $('#modal').find('.modal-header').html(`<h5>Deseja realmente deletar o produto ${item} ?</h5>`)
      $('#modal').find('.modal-footer').html(`<button class="btn btn-outline-secondary" onclick="closeModal()">Não</button> <button class="btn btn-primary" onclick="deleteProduct('${id}')">Sim</button>`)
    }

    const closeModal = () => {
      $('#modal').modal('hide')
      $('#modal').find('.modal-header').html('')
      $('#modal').find('.modal-footer').html('')
    }

    const deleteProduct = (id) => {
      $.ajax ({
        "method": "POST",
        "url": "{% url 'product:delete' %}",
        "headers": {
          "X-CSRFToken": csrf_token,
        },
        "data": {"id": id},
        success: function(response) {
          table.row(`#row_${id}`).remove().draw(false);
          closeModal()
          $("#message-ajax").html(`
          <div class="alert alert-success alert-dismissible fade show" role="alert">
            ${response.message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          `)
        }
      })
    }
</script>
{% endblock %}